{"version":3,"sources":["assets\\Script\\game\\heavenBox.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import { AdPosition } from \"../common/AdPosition\";\nimport { gameState } from \"../common/faceTs\";\nimport NameTs from \"../common/NameTs\";\nimport pool from \"../common/pool\";\nimport { UrlConst } from \"../server/UrlConst\";\nimport AdController from \"../server/xmsdk_cocos/AD/AdController\";\nimport TrackMgr from \"../TrackMgr/TrackMgr\";\nimport util from \"../util/util\";\n\nconst {ccclass, property} = cc._decorator;\n\n@ccclass\nexport default class heavenBox extends cc.Component {\n\n    \n\n    // LIFE-CYCLE CALLBACKS:\n    @property({type:cc.Prefab,displayName:\"天降金币的预制体\"})\n    private heavenPre:cc.Prefab = null;\n\n    //池塘\n    private pool:pool = null;\n\n    //天降次数\n    private heavenNum:number = 100;//剩余次数\n    // //存在多少个\n    private existCoinNum:number = 0;\n\n    \n\n    //判断是否进行天降金币\n    private HeavenData:{ing:boolean,time:number} = {ing:false,time:null};\n\n    onLoad () {\n\n        util.initHeavenPool();\n\n        let item:cc.Node = cc.instantiate(this.heavenPre);\n        this.pool = new pool(item,5);\n\n        //天降金币\n        // cc.game.on(NameTs.Game_Start,(res)=>{\n        //     if(this.HeavenData.ing)return;\n            this.HeavenData.time = util.GetHeavenTime();\n            this.HeavenData.ing = true;\n        // },this);\n\n        util.getdataStr({\n            url:UrlConst.heavenCoin_main,\n            success:(res)=>{\n                if(res && res.list){\n                    if(!this.isValid){\n                        return;\n                    }\n\n                    this.heavenNum = res.remainingTimes+res.list.length;\n                    res.list.forEach(element => {\n                        this.createHeaven(element);\n                    });\n                }\n            },\n            fail:()=>{\n\n            }\n        });\n        //回收\n        cc.game.on(NameTs.Game_Heaven_killed,(node)=>{\n            this.pool.onEnemyKilled(node);\n            this.existCoinNum--;\n        },this);\n\n        // this.createHeaven();\n\n        // console.log(util.userData.heavenPool,'this.userData.heavenPool')\n    \n\n        \n\n    }\n\n    start () {\n\n    }\n\n    /**\n     * 添加金币监听\n     * @param dt \n     */\n    HeavenMonitor(dt){\n        if(util.levelState!==gameState.start||this.heavenNum<=0)return;\n        if(this.HeavenData.ing){\n            this.HeavenData.time-=dt;\n            // console.log(this.HeavenData.time,'this.HeavenData.time')\n            if(this.HeavenData.time<0){\n                this.HeavenData.time = util.GetHeavenTime();\n                this.createHeaven();\n            }\n        }\n    }\n\n    /**\n     * 创建天降金币\n     * @param data {id:numberm,coin:number}\n     */\n    createHeaven(data?:{id:number,point:number}){\n        //超过12个就886\n        if(this.existCoinNum>=12)return;\n\n        //预加载金币信息流\n        if(!util.adPreObj[AdPosition.HeavenCoinView]){\n            util.preloadAd(AdPosition.HeavenCoinView,true);\n        }\n\n        let location:number = util.GetHeavenPlace();\n        if(!location){\n            //console.error(\"没有位置\");\n            TrackMgr.airborne_gold({\n                activity_state: \"金币下发\",\n                distribution_status: false,\n                failure_reasons: \"没有位置\"\n            })\n            return;\n        }\n        \n        //占位置\n        let successFn = (data)=>{\n            if(util.checkHeavenPool(location)){\n                location = util.GetHeavenPlace();\n            }\n            this.existCoinNum++;\n            util.saveHeavenPool(location,data.id,data.point);\n            this.pool.createEnemy(this.node,{no:location,data});\n        }\n        if(data){\n            successFn(data);\n        }else{\n            util.saveHeavenPool(location,1,1);\n            util.getdataStr({\n                url:UrlConst.heavenCoin_get,\n                success:(res)=>{\n                    if(!this.isValid){\n                        return;\n                    }\n\n                    util.saveHeavenPool(location,null);\n                    if(res.id!==null){\n                        successFn(res);\n                        TrackMgr.airborne_gold({\n                            activity_state: \"金币下发\",\n                            distribution_status: true,\n                        })\n                    }else{\n                        if(res.id==null&&res.distanceTime==null){\n                            this.existCoinNum = 12;\n                            util.saveHeavenPool(location,null);\n                            return;\n                        }\n                        this.HeavenData.time = Math.floor(res.distanceTime/1000);\n                        console.error(\"未到时间\")\n                        TrackMgr.airborne_gold({\n                            activity_state: \"金币下发\",\n                            distribution_status: false,\n                            failure_reasons: \"未到时间\"\n                        })\n                    }\n                },\n                fail:(error)=>{\n                    util.saveHeavenPool(location,null);\n                    TrackMgr.airborne_gold({\n                        activity_state: \"金币下发\",\n                        distribution_status: false,\n                        failure_reasons: error\n                    })\n                    console.error(\"错误：\"+error)\n                }\n            })\n        };\n        \n\n    }\n\n\n    /**\n     * \n     * @param dt \n     */\n\n\n    update (dt) {\n        \n        this.HeavenMonitor(dt);\n    }\n\n\n    \n}\n"]}