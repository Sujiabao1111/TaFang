{"version":3,"sources":["assets\\Script\\game\\turret\\turretBullet.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import baseTs from \"../../base/baseTs\";\nimport { bulletInfo, gameState } from \"../../common/faceTs\";\nimport NameTs from \"../../common/NameTs\";\nimport tool from \"../../util/tool\";\nimport util from \"../../util/util\";\n\nconst {ccclass, property} = cc._decorator;\n\n@ccclass\nexport default class turretBullet extends cc.Component {\n\n    @property({type:cc.Sprite,displayName:\"炮弹图片\"})\n    bulletPic: cc.Sprite = null;\n    \n    @property({type:sp.Skeleton,displayName:\"炮弹骨骼\"})\n    bulletSpine: sp.Skeleton = null;\n\n    // onLoad () {}\n    /**目标节点*/\n    private targetNode:cc.Node;\n\n    /**初始数据 */\n    private initData;\n\n    /**是否瞬间 */\n    private isMoment:boolean = false;\n\n    //子弹数据\n    private bulletData:any;\n\n    //是否旋转\n    private isAngle:boolean = null;\n\n    start () {\n        \n    }\n\n    /**初始化 */\n    init(data){        \n        this.initData = data.data;\n        \n        this.bulletPic.node.active = this.bulletSpine.node.active = false;\n        this.bulletData = util.GetBulletData(this.initData.type);\n        // if(!this.bulletPic){\n        //     let aaa = this.initData.type;\n        // }\n        let pos:cc.Vec2 = cc.Vec2.clone(data.pos);\n        //设置出生位置\n        // this.destroyIng = false;\n        this.isMoment = false;\n        this.node.setPosition(pos);\n        this.node.angle = this.bulletSpine.node.angle = this.bulletPic.node.angle = 0;\n        this.isAngle = this.bulletData.type == 1?false:null;\n        this.bulletSpine.node.scale = 1;\n\n        //用于出厂动画\n        // this.node.scale = 0;\n\n        let name:string = util.userData.customs.big+\"-\"+util.userData.customs.small+\"_Monster_\"+this.initData.targetId;\n        this.targetNode = util.MonsterMap.get(name);\n\n        //如果找不到就删除\n        if(!this.targetNode){\n            this.destroyBullet();\n            return;\n        }\n\n        if(this.bulletData.bulletSpine==1){\n            this.bulletSpine.node.active = true;\n            this.isMoment = true;\n            this.loadSpine();\n        }else{\n            this.bulletPic.node.active = true\n            this.isMoment = false;\n            this.loadSprite();\n        }\n\n    }\n\n    /**\n     * 加载图片\n     */\n    loadSprite(){\n        if(this.bulletPic){\n            this.bulletPic.spriteFrame = null;\n        } \n        cc.resources.load(\"spine/turret/\"+this.bulletData.type+\"/bullet/paodan\",cc.SpriteFrame, (error, res:cc.SpriteFrame) => {\n            if(this.bulletPic){\n                this.bulletPic.spriteFrame = res;\n            }    \n        });\n\n    }\n\n    /**\n     * 加载龙骨\n     */\n    loadSpine(){\n        if(this.bulletSpine){\n            this.bulletSpine.skeletonData = null;\n        }\n        cc.resources.load(\"spine/turret/\"+this.bulletData.type+\"/bullet/\"+this.bulletData.name,sp.SkeletonData, (error, sp:sp.SkeletonData) => {\n            if(error){\n                cc.warn(error);\n                return;\n            }\n            this.bulletSpine.skeletonData = sp;\n            if(this.bulletData.Spine==1){\n                this.bulletSpine.setAnimation(0,this.bulletData.animationName,this.bulletData.loop==\"1\");\n                this.isMoment = false;\n            }else{\n                this.bulletSpine.clearTracks();\n                this.playAni();\n            }\n        });\n\n    }\n\n    update (dt) {\n        //游戏暂停\n        if(util.levelState == gameState.stop||this.isMoment)return;\n        //没有父节点或者目标\n        if(!this.targetNode||!this.targetNode.parent){\n            this.destroyBullet();\n            return;\n        };\n        //目标点\n        let targetPos:cc.Vec2 = cc.Vec2.clone(this.targetNode.getPosition());\n\n        targetPos = this.targetNode.parent.convertToWorldSpaceAR(targetPos);\n        targetPos = this.node.parent.convertToNodeSpaceAR(targetPos);\n       \n        let selfPos:cc.Vec2 = this.node.getPosition();\n        //距离\n        if(this.isAngle==null){\n            this.node.angle = tool.GetPosAngle(selfPos,targetPos);\n        }\n\n        let distance:number = selfPos.sub(targetPos).mag();\n        if(distance<=this.targetNode.width/2){\n            this.targetNode = null;\n            this.hurtMonster();\n            this.destroyBullet();\n            return;\n        }\n        \n        let normalizeVec: cc.Vec2 = targetPos.subtract(selfPos).normalize();\n\n        this.node.x += normalizeVec.x * this.initData.speed * dt;\n        this.node.y += normalizeVec.y * this.initData.speed * dt;\n\n    }\n\n\n\n    /**\n     * 播放动画\n     */\n    playAni(){\n        if(!this.targetNode||!this.targetNode.parent||!this.isMoment){\n            this.destroyBullet();\n            return\n        }\n\n        //目标点\n        let targetPos:cc.Vec2 = this.targetNode.getPosition();\n\n        if(!targetPos||!this.node.parent){\n            this.destroyBullet();\n            return\n        }\n        targetPos = this.targetNode.parent.convertToWorldSpaceAR(targetPos);\n        targetPos = this.node.parent.convertToNodeSpaceAR(targetPos);\n       \n        let selfPos:cc.Vec2 = this.node.getPosition();\n\n        //距离\n        this.node.angle = tool.GetPosAngle(selfPos,targetPos);\n\n        let distance:number = targetPos.sub(selfPos).mag();\n        \n        this.bulletSpine.node.y = Number(this.bulletData.Y);\n        let nodeWidth:number = Number(this.bulletData.width);\n\n        this.bulletSpine.node.scaleY = distance/(this.bulletData.bulletSpine==1?nodeWidth:this.bulletSpine.node.height)*1.3;\n        if(!targetPos||!this.node.parent){\n            this.destroyBullet();\n            return\n        }\n\n        \n        // this.bulletSpine.node.opacity = 0;\n        this.bulletSpine.setAnimation(0,this.bulletData.animationName,false);\n\n        if(this.bulletData.type == 30){\n            this.scheduleOnce(()=>{\n                this.hurtMonster();\n            },.1);\n        }else{\n            this.hurtMonster();\n        }\n\n        // this.bulletSpine.setCompleteListener(()=>{\n        //     this.destroyBullet();\n        // });\n        this.scheduleOnce(()=>{\n            this.destroyBullet();\n        },.5);\n\n    }\n\n    /**回收自己 */\n    destroyBullet(){\n        //回收自己\n        cc.game.emit(NameTs.Game_Turret_Bullet_Killed,this.node);\n       \n    }\n\n    /**受伤 */\n    hurtMonster(){\n        //暴击\n        let crit:number = (Math.random()<(this.initData.crit/100))?2:1;\n        //爆炸伤害\n        cc.game.emit(NameTs.Game_Bullet_Boom_Creator,{type:this.initData.type,id:this.initData.targetId});\n        //怪物受伤\n        let monsetrName:string = util.userData.customs.big+\"-\"+util.userData.customs.small+\"_Monster_\"+this.initData.targetId;\n        cc.game.emit(NameTs.Game_Monster_Bruise+monsetrName,{num:this.initData.atk,crit});\n        \n    }\n}\n"]}